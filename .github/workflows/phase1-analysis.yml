name: Phase 1 Analysis

# CONTROL-PLANE WORKFLOW (Orchestration and artifact management only)
# 
# ARCHITECTURE SEPARATION:
#   - Control-plane: This workflow (GitHub Actions) - artifact upload and status tracking
#   - Execution-plane: run_phase1_analysis.py (stable runners) - Transform execution
#
# AWS Transform is intentionally NOT executed here due to:
#   - Large, stateful output requiring persistent storage
#   - ATX early-access instability in ephemeral CI runners
#   - Long execution times (1-2+ hours) requiring human oversight
#
# This workflow handles artifact upload after execution completes on stable runners.
# Repository discovery and Transform execution happen when run_phase1_analysis.py
# is executed on a stable runner (IDE/Codespaces/EC2).

on:
  workflow_dispatch:  # Manual trigger button in GitHub Actions UI
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC (optional)
  push:
    paths:
      - 'config/repos.yaml'  # Trigger when config changes

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      # NOTE: AWS Transform CLI and credentials are NOT installed here
      # Transform execution happens on stable runners (IDE/Codespaces/EC2)
      # This workflow only handles artifact upload after execution completes
      
      - name: Upload analysis results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: repos/
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload Transform logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: transform-logs
          # Matches log files from stable-runner execution (e.g., legacy-java-demo_transform.log)
          path: repos/*.log
          if-no-files-found: warn
