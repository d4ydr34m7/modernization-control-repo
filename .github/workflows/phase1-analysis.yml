name: Phase 1 Analysis

# SELF-HOSTED RUNNER EXECUTION (EC2 / Long-lived Machine)
# 
# ARCHITECTURE:
#   - Control-plane: GitHub Actions (orchestration, artifact upload)
#   - Execution-plane: Self-hosted runner (EC2 / long-lived machine)
#
# The self-hosted runner must be:
#   - Always on (or automatically started before scheduled runs)
#   - Long-running (not ephemeral like GitHub-hosted runners)
#   - Not subject to CI payload limits (persistent storage for large outputs)
#
# PREREQUISITES on self-hosted runner:
#   - AWS Transform CLI installed and configured
#   - AWS credentials configured (SSO or environment variables)
#   - Python 3.11+ available
#   - GitHub Actions runner agent installed and running
#
# This workflow executes run_phase1_analysis.py on the self-hosted runner,
# then uploads analysis results and logs as artifacts.

on:
  workflow_dispatch:  # Manual trigger button in GitHub Actions UI
  schedule:
    # TEMP: 5-minute schedule for testing. Will revert to weekly after validation.
    - cron: '*/5 * * * *'
  push:
    paths:
      - 'config/repos.yaml'  # Trigger when config changes

jobs:
  analyze:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Verify AWS Transform CLI
        run: |
          if ! command -v atx &> /dev/null; then
            echo "Error: AWS Transform CLI (atx) not found. Install it first:"
            echo "  curl -fsSL https://desktop-release.transform.us-east-1.api.aws/install.sh | bash"
            exit 1
          fi
          atx --version
      
      - name: Verify AWS credentials
        run: |
          # Check if AWS credentials are configured
          if ! aws sts get-caller-identity &> /dev/null; then
            echo "Warning: AWS credentials not configured. Analysis may fail."
            echo "Configure credentials using: aws configure sso"
          else
            echo "AWS credentials verified"
            aws sts get-caller-identity
          fi
      
      - name: Run Phase 1 Analysis
        env:
          # Use custom token if available (required for org_scan mode with read:org permission)
          # Otherwise falls back to default GITHUB_TOKEN (may not have org read permissions)
          GITHUB_TOKEN_CUSTOM: ${{ secrets.GITHUB_TOKEN_CUSTOM }}
          GITHUB_TOKEN_DEFAULT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export GITHUB_TOKEN="${GITHUB_TOKEN_CUSTOM:-$GITHUB_TOKEN_DEFAULT}"
          python scripts/run_phase1_analysis.py
      
      - name: Upload analysis results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: repos/
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload Transform logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: transform-logs
          # Matches log files from analysis execution (e.g., legacy-java-demo_transform.log)
          path: repos/*.log
          if-no-files-found: warn
